name: æå–å¹¶å¤„ç†M3Ué¢‘é“

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  extract-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½M3Uæ–‡ä»¶
      run: |
        echo "æ­£åœ¨ä¸‹è½½M3Uæ–‡ä»¶..."
        curl -L -o source.m3u "https://raw.githubusercontent.com/Jsnzkpg/Jsnzkpg/Jsnzkpg/Jsnzkpg1.m3u"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
        if [ ! -f source.m3u ]; then
          echo "é”™è¯¯ï¼šæ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        echo "æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œå¤§å°ï¼š$(wc -c < source.m3u) å­—èŠ‚"
        
    - name: æå–å¹¶å¤„ç†é¢‘é“
      run: |
        echo "æ­£åœ¨æå–æŒ‡å®šåˆ†ç±»é¢‘é“..."
        
        # åˆ›å»ºæ–°çš„M3Uæ–‡ä»¶
        echo "#EXTM3U" > kulaoTV.m3u
        
        # å®šä¹‰éœ€è¦ä¿ç•™çš„group-title
        patterns=(
          "ğŸï¸ç”µå½±ç›´æ’­"
          "ğŸ“ºç”µè§†å‰§ç›´æ’­"
          "ğŸ’½çºªå½•ç‰‡ç›´æ’­"
          "ğŸ§éŸ³ä¹ç›´æ’­"
          "ğŸ€[è”é€š]å’ªè§†ç•Œç›´æ’­"
        )
        
        # ä½¿ç”¨awkå¤„ç†æ–‡ä»¶
        awk -v patterns="${patterns[*]}" '
        BEGIN {
          split(patterns, pat_array, " ")
          channel_count = 0
        }
        
        /^#EXTINF:/ {
          # ä¿å­˜å½“å‰è¡Œ
          current_line = $0
          matched = 0
          
          # æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•æ¨¡å¼
          for (i in pat_array) {
            if (index(current_line, "group-title=\"" pat_array[i] "\"")) {
              matched = 1
              break
            }
          }
          
          if (matched) {
            # è¿›è¡Œæ›¿æ¢
            gsub(/group-title="ğŸï¸ç”µå½±ç›´æ’­"/, "group-title=\"ç”µå½±ç›´æ’­\"", current_line)
            gsub(/group-title="ğŸ“ºç”µè§†å‰§ç›´æ’­"/, "group-title=\"ç”µè§†å‰§ç›´æ’­\"", current_line)
            gsub(/group-title="ğŸ’½çºªå½•ç‰‡ç›´æ’­"/, "group-title=\"çºªå½•ç‰‡ç›´æ’­\"", current_line)
            gsub(/group-title="ğŸ§éŸ³ä¹ç›´æ’­"/, "group-title=\"éŸ³ä¹ç›´æ’­\"", current_line)
            gsub(/group-title="ğŸ€\[è”é€š\]å’ªè§†ç•Œç›´æ’­"/, "group-title=\"å’ªè§†ç•Œç›´æ’­\"", current_line)
            
            # ä¿å­˜å¤„ç†åçš„è¡Œ
            print current_line
            getline url_line
            print url_line
            channel_count++
          }
        }
        
        END {
          print "æå–å®Œæˆï¼Œå…± " channel_count " ä¸ªé¢‘é“" > "/dev/stderr"
        }
        ' source.m3u >> kulaoTV.m3u
        
        # æ£€æŸ¥ç»“æœ
        channel_count=$(grep -c "^#EXTINF" kulaoTV.m3u)
        echo "å¤„ç†å®Œæˆï¼å…±æå– ${channel_count} ä¸ªé¢‘é“"
        
    - name: æ˜¾ç¤ºç»“æœç»Ÿè®¡
      run: |
        echo "ğŸ“Š æå–ç»“æœç»Ÿè®¡ï¼š"
        echo "----------------------------------------"
        echo "æ–‡ä»¶ï¼škulaoTV.m3u"
        echo "å¤§å°ï¼š$(wc -c < kulaoTV.m3u) å­—èŠ‚"
        echo "é¢‘é“æ€»æ•°ï¼š$(grep -c "^#EXTINF" kulaoTV.m3u)"
        echo ""
        echo "å„åˆ†ç±»é¢‘é“æ•°é‡ï¼š"
        grep "group-title=" kulaoTV.m3u | grep -o 'group-title="[^"]*"' | sort | uniq -c
        echo "----------------------------------------"
        
    - name: æ£€æŸ¥æ–‡ä»¶æœ‰æ•ˆæ€§
      run: |
        if [ ! -s kulaoTV.m3u ]; then
          echo "âŒ é”™è¯¯ï¼šç”Ÿæˆçš„kulaoTV.m3uæ–‡ä»¶ä¸ºç©º"
          exit 1
        fi
        
        if [ $(grep -c "^#EXTINF" kulaoTV.m3u) -eq 0 ]; then
          echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é¢‘é“"
          exit 1
        fi
        
        echo "âœ… æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
        
    - name: æäº¤æ›´æ”¹
      run: |
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        if [ -f kulaoTV.m3u ]; then
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add kulaoTV.m3u
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ”¹åŠ¨éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "æ›´æ–°kulaoTV.m3uæ–‡ä»¶ - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… å·²æäº¤æ›´æ–°åˆ°ä»“åº“"
          fi
        else
          echo "âŒ é”™è¯¯ï¼škulaoTV.m3uæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
