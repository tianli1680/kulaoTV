name: æå–å¹¶å¤„ç†M3Ué¢‘é“

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  extract-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½M3Uæ–‡ä»¶
      run: |
        echo "æ­£åœ¨ä¸‹è½½M3Uæ–‡ä»¶..."
        curl -L -o source.m3u "https://raw.githubusercontent.com/Jsnzkpg/Jsnzkpg/Jsnzkpg/Jsnzkpg1.m3u"
        
    - name: æå–å¹¶å¤„ç†é¢‘é“
      run: |
        echo "æ­£åœ¨æå–æŒ‡å®šåˆ†ç±»é¢‘é“..."
        
        # åˆ›å»ºæ–°çš„M3Uæ–‡ä»¶ï¼Œæ·»åŠ æ–‡ä»¶å¤´
        echo "#EXTM3U" > kulaoTV.m3u
        
        # å®šä¹‰éœ€è¦ä¿ç•™çš„group-titleæ¨¡å¼
        PATTERNS=(
          'group-title="ğŸï¸ç”µå½±ç›´æ’­"'
          'group-title="ğŸ“ºç”µè§†å‰§ç›´æ’­"'
          'group-title="ğŸ’½çºªå½•ç‰‡ç›´æ’­"'
          'group-title="ğŸ§éŸ³ä¹ç›´æ’­"'
          'group-title="ğŸ€[è”é€š]å’ªè§†ç•Œç›´æ’­"'
        )
        
        # è¯»å–æ–‡ä»¶å¹¶å¤„ç†
        current_line=""
        channel_count=0
        
        while IFS= read -r line || [ -n "$line" ]; do
          # è·³è¿‡æ–‡ä»¶å¤´è¡Œ
          if [[ $line == \#EXTM3U* ]]; then
            continue
          fi
          
          # å¦‚æœæ˜¯EXTINFè¡Œï¼ˆé¢‘é“ä¿¡æ¯è¡Œï¼‰
          if [[ $line == \#EXTINF:* ]]; then
            current_line="$line"
          # å¦‚æœæ˜¯URLè¡Œï¼ˆç´§æ¥ç€EXTINFè¡Œçš„ä¸‹ä¸€è¡Œï¼‰
          elif [[ -n "$current_line" ]] && [[ ! "$line" =~ ^# ]]; then
            # æ£€æŸ¥å½“å‰ç¼“å­˜çš„EXTINFè¡Œæ˜¯å¦åŒ…å«ä»»ä¸€ç›®æ ‡group-title
            matched=false
            for pattern in "${PATTERNS[@]}"; do
              if [[ "$current_line" == *"$pattern"* ]]; then
                matched=true
                break
              fi
            done
            
            if [ "$matched" = true ]; then
              # è¿›è¡Œæ ‡é¢˜æ›¿æ¢
              modified_line="$current_line"
              modified_line="${modified_line//group-title=\"ğŸï¸ç”µå½±ç›´æ’­\"/group-title=\"ç”µå½±ç›´æ’­\"}"
              modified_line="${modified_line//group-title=\"ğŸ“ºç”µè§†å‰§ç›´æ’­\"/group-title=\"ç”µè§†å‰§ç›´æ’­\"}"
              modified_line="${modified_line//group-title=\"ğŸ’½çºªå½•ç‰‡ç›´æ’­\"/group-title=\"çºªå½•ç‰‡ç›´æ’­\"}"
              modified_line="${modified_line//group-title=\"ğŸ§éŸ³ä¹ç›´æ’­\"/group-title=\"éŸ³ä¹ç›´æ’­\"}"
              modified_line="${modified_line//group-title=\"ğŸ€[è”é€š]å’ªè§†ç•Œç›´æ’­\"/group-title=\"å’ªè§†ç•Œç›´æ’­\"}"
              
              # å†™å…¥å¤„ç†åçš„è¡Œå’ŒURL
              echo "$modified_line" >> kulaoTV.m3u
              echo "$line" >> kulaoTV.m3u
              ((channel_count++))
            fi
            current_line=""
          else
            # é‡ç½®current_lineï¼ˆå¤„ç†å¼‚å¸¸æƒ…å†µï¼‰
            current_line=""
          fi
        done < source.m3u
        
        echo "å¤„ç†å®Œæˆï¼å…±æå– $channel_count ä¸ªé¢‘é“"
        
    - name: æ˜¾ç¤ºæ–‡ä»¶å†…å®¹ï¼ˆè°ƒè¯•ï¼‰
      run: |
        echo "ç”Ÿæˆçš„kulaoTV.m3uæ–‡ä»¶å†…å®¹ï¼š"
        echo "----------------------------------------"
        cat kulaoTV.m3u
        echo "----------------------------------------"
        echo "æ–‡ä»¶å¤§å°ï¼š$(wc -c < kulaoTV.m3u) å­—èŠ‚"
        echo "é¢‘é“æ•°é‡ï¼š$(grep -c "^#EXTINF" kulaoTV.m3u)"
        
    - name: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
      id: check_file
      run: |
        if [ ! -f kulaoTV.m3u ] || [ ! -s kulaoTV.m3u ]; then
          echo "é”™è¯¯ï¼škulaoTV.m3u æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          exit 1
        fi
        echo "æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
        
    - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
      id: check_changes
      run: |
        if git ls-files --error-unmatch kulaoTV.m3u >/dev/null 2>&1; then
          if git diff --quiet kulaoTV.m3u; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "æ–‡ä»¶æ— å˜åŒ–"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "æ–‡ä»¶æœ‰å˜åŒ–"
          fi
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "æ–‡ä»¶æ˜¯æ–°å¢çš„"
        fi
        
    - name: æäº¤æ›´æ”¹
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add kulaoTV.m3u
        git commit -m "æ›´æ–°kulaoTV.m3uæ–‡ä»¶ - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
        echo "å·²æäº¤æ›´æ”¹åˆ°ä»“åº“"
        
    - name: å®Œæˆæç¤º
      run: |
        echo "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼"
        echo "æ–‡ä»¶å·²ä¿å­˜åˆ°ä»“åº“æ ¹ç›®å½•ï¼škulaoTV.m3u"
