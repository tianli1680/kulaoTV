name: æå–å¹¶å¤„ç†M3Ué¢‘é“

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  extract-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½M3Uæ–‡ä»¶
      run: |
        echo "æ­£åœ¨ä¸‹è½½M3Uæ–‡ä»¶..."
        curl -L -o source.m3u "https://raw.githubusercontent.com/Jsnzkpg/Jsnzkpg/Jsnzkpg/Jsnzkpg1.m3u"
        
    - name: æå–å¹¶å¤„ç†é¢‘é“
      run: |
        echo "æ­£åœ¨æå–æŒ‡å®šåˆ†ç±»é¢‘é“..."
        
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
        touch temp.m3u
        
        # å®šä¹‰éœ€è¦ä¿ç•™çš„group-titleæ¨¡å¼
        PATTERNS=(
          'group-title="ğŸï¸ç”µå½±ç›´æ’­"'
          'group-title="ğŸ“ºç”µè§†å‰§ç›´æ’­"'
          'group-title="ğŸ’½çºªå½•ç‰‡ç›´æ’­"'
          'group-title="ğŸ§éŸ³ä¹ç›´æ’­"'
          'group-title="ğŸ€[è”é€š]å’ªè§†ç•Œç›´æ’­"'
        )
        
        # è¯»å–æ–‡ä»¶å¹¶å¤„ç†
        current_line=""
        while IFS= read -r line; do
          # å¦‚æœæ˜¯EXTINFè¡Œï¼ˆé¢‘é“ä¿¡æ¯è¡Œï¼‰
          if [[ $line == \#EXTINF:* ]]; then
            current_line="$line"
          # å¦‚æœæ˜¯URLè¡Œï¼ˆç´§æ¥ç€EXTINFè¡Œçš„ä¸‹ä¸€è¡Œï¼‰
          elif [[ ! -z "$current_line" ]]; then
            # æ£€æŸ¥å½“å‰ç¼“å­˜çš„EXTINFè¡Œæ˜¯å¦åŒ…å«ä»»ä¸€ç›®æ ‡group-title
            for pattern in "${PATTERNS[@]}"; do
              if [[ "$current_line" == *"$pattern"* ]]; then
                # è¿›è¡Œæ ‡é¢˜æ›¿æ¢
                modified_line="$current_line"
                modified_line="${modified_line//group-title=\"ğŸï¸ç”µå½±ç›´æ’­\"/group-title=\"ç”µå½±ç›´æ’­\"}"
                modified_line="${modified_line//group-title=\"ğŸ“ºç”µè§†å‰§ç›´æ’­\"/group-title=\"ç”µè§†å‰§ç›´æ’­\"}"
                modified_line="${modified_line//group-title=\"ğŸ’½çºªå½•ç‰‡ç›´æ’­\"/group-title=\"çºªå½•ç‰‡ç›´æ’­\"}"
                modified_line="${modified_line//group-title=\"ğŸ§éŸ³ä¹ç›´æ’­\"/group-title=\"éŸ³ä¹ç›´æ’­\"}"
                modified_line="${modified_line//group-title=\"ğŸ€[è”é€š]å’ªè§†ç•Œç›´æ’­\"/group-title=\"å’ªè§†ç•Œç›´æ’­\"}"
                
                # å†™å…¥å¤„ç†åçš„è¡Œå’ŒURL
                echo "$modified_line" >> temp.m3u
                echo "$line" >> temp.m3u
                break
              fi
            done
            current_line=""
          else
            # å¿½ç•¥å…¶ä»–è¡Œï¼ˆå¦‚EXTM3Uå¤´ï¼‰
            :
          fi
        done < source.m3u
        
        # æ·»åŠ æ–‡ä»¶å¤´
        echo "#EXTM3U" > kulaoTV.m3u
        cat temp.m3u >> kulaoTV.m3u
        rm temp.m3u
        
        echo "å¤„ç†å®Œæˆï¼å…±æå– $(grep -c "^#EXTINF" kulaoTV.m3u) ä¸ªé¢‘é“"
        
    - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
      id: check_changes
      run: |
        if [ -f kulaoTV.m3u ]; then
          if git diff --quiet kulaoTV.m3u; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
        
    - name: æäº¤æ›´æ”¹
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add kulaoTV.m3u
        git commit -m "æ›´æ–°kulaoTV.m3uæ–‡ä»¶ - $(date +'%Y-%m-%d')"
        git push
